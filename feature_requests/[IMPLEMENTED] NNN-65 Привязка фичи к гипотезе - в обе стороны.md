# Проблема

*Вообще, непонятно в какой момент происходит переход от дискавери к деливери. При создании фичи? Уже на доске?*

Предполагаемый процесс работает так:
1. Все задачи падают в Inbox.
2. Те, что требуют Discovery, перекладываются в соответствующую колонку и на их базе создаются гипотеза или гипотезы.
3. По итогам проработки гипотезы может возникнуть новая задача или несколько задач, они упадут сразу в бэклог

# Решение

*2c. Нужна возможность прилинковать фичу с гипотезой (много-к-одному)*

Решение должно работать в 2 сценариях:
1. Если при обработке задачи из Inbox пользователь натыкается на необходимость пустить её по циклу Discovery, он должен создать на её базе гипотезу, при этом линк на гипотезу нужно оставить в задаче

2. Если задача, напротив, создаётся из гипотезы, линк на эту гипотезу заполняется автоматически.

## Ограничения

- Если гипотеза была клонирована, исходная задача про это "не узнает", там останется линк на первую гипотезу
- Если на базе задачи создаётся новая гипотеза, то её линк перезатирает старый

Это естественные ограничения отношения один-ко-многим, принимаем их как данность.

# Реализация

## Данные

Для каждой фичи появляется дополнительное поле линка на сущность гипотезы. Поле необязательное, значения по умолчанию нет.

## Управление

Поле можно заполнить в произвольный момент, при создании или редактировании фичи. Дополнительно к этому оно заполняется автоматически в следующих случаях:

1. Фича создаётся на базе гипотезы (уже существующая возможность) - в таком случае поле заполняется ссылкой на эту гипотезу.

2. Появляется новая опция - Discovery this feature (инициируется кнопкой в редакторе фичи). В случае её активации:
2.1. Открывается редактор гипотезы с предзаполненным инсайтом (заголовок фичи) и проблемой (описание фичи).
2.2. В случае **сохранения гипотезы** линк на неё записывается в ту фичу, откуда было вызвано её создание (перезаписывая существующий, если таковой был). 
2.3. Фича переносится в раздел Discovery.

---

# ✅ Реализовано

## Выполненные изменения

### База данных
- ✅ Добавлено поле `hypothesis_id` в таблицу `features` (nullable, FK к `hypotheses`)
- ✅ Создан индекс `idx_features_hypothesis_id` для оптимизации запросов
- ✅ Настроено каскадное обновление: при удалении гипотезы `hypothesis_id` становится `NULL` (ON DELETE SET NULL)

### TypeScript типы
- ✅ Обновлены типы в `src/integrations/supabase/types.ts`:
  - Добавлено `hypothesis_id: string | null` в `Row`
  - Добавлено `hypothesis_id?: string | null` в `Insert` и `Update`
  - Добавлен relationship в массив `Relationships`

### Интерфейсы
- ✅ Обновлен интерфейс `Feature` в `BoardPage.tsx` и `HypothesesPage.tsx`:
  - Добавлено поле `hypothesis_id?: string`

### Функциональность

#### 1. Создание фичи из гипотезы
- ✅ При создании фичи из гипотезы (кнопка "Create Feature" в диалоге гипотезы) автоматически устанавливается `hypothesis_id`
- ✅ Поле предзаполняется данными из гипотезы (insight → title, solution_hypothesis → description)

#### 2. Ручное связывание фичи с гипотезой
- ✅ Добавлено поле "Linked Hypothesis" в редакторе фичи на странице Board
- ✅ Поиск по гипотезам с фильтрацией
- ✅ Возможность сброса привязки (опция "None")
- ✅ Отображение выбранной гипотезы (insight текст)

#### 3. Создание гипотезы из фичи (Discovery this feature)
- ✅ Добавлена кнопка "Discovery this feature" в редакторе фичи
- ✅ Кнопка доступна только для сохраненных фич (disabled для несохраненных с информативным tooltip)
- ✅ При нажатии открывается диалог создания гипотезы с предзаполненными полями:
  - Insight: заголовок фичи
  - Problem Hypothesis: описание фичи
- ✅ После сохранения гипотезы:
  - Фича автоматически привязывается к созданной гипотезе
  - Фича автоматически переносится в колонку "Discovery"
  - Оба диалога закрываются автоматически

### UI/UX
- ✅ Поле "Linked Hypothesis" визуально согласовано с полями "Linked Goal" и "Linked Initiative"
- ✅ Использован тот же паттерн UI (Popover + Command для поиска)
- ✅ Интеграция в двухколоночный диалог редактирования фичи

### Документация
- ✅ Обновлен `docs/data-model.md` с описанием связи features-hypotheses
- ✅ Обновлен `docs/board-page.md` с описанием новой функциональности
- ✅ Обновлен `docs/hypotheses-page.md` с описанием автоматической привязки
- ✅ Создан чеклист тестирования `docs/testing-checklist-hypothesis-feature-link.md`

## Технические детали

- **Отношение**: Много-к-одному (много фич могут ссылаться на одну гипотезу)
- **Каскадное удаление**: При удалении гипотезы все ссылки в фичах автоматически сбрасываются
- **Ограничения**: 
  - При клонировании гипотезы фичи остаются привязанными к исходной гипотезе
  - При создании новой гипотезы из фичи старая привязка перезаписывается

## Миграция

- Файл: `supabase/migrations/20260109170000_add_hypothesis_id_to_features.sql`
- Обновлена финальная схема: `supabase/migrations/final_full_schema.sql`
